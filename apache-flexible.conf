# Apache Staging Configuration
# File: /etc/apache2/sites-available/nusantara-staging.conf

<VirtualHost *:443>
    ServerName nusantaragroup.co
    ServerAlias www.nusantaragroup.co
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/nusantaragroup.co/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/nusantaragroup.co/privkey.pem
    
    # Security Headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # For Staging Mode (docker-compose.staging.yml)
    # Uncomment these lines when using staging:
    # ProxyPass / http://127.0.0.1:8080/
    # ProxyPassReverse / http://127.0.0.1:8080/
    # ProxyPass /api/ http://127.0.0.1:5000/
    # ProxyPassReverse /api/ http://127.0.0.1:5000/
    
    # For Production Mode (docker-compose.production.yml) - DEFAULT
    ProxyPass / http://127.0.0.1:8081/
    ProxyPassReverse / http://127.0.0.1:8081/
    ProxyPass /api/ http://127.0.0.1:5001/
    ProxyPassReverse /api/ http://127.0.0.1:5001/
    
    # Preserve Host and Protocol
    ProxyPreserveHost On
    ProxyRequests Off
    
    # WebSocket support for development
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://127.0.0.1:8080/$1" [P,L]
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/nusantara_error.log
    CustomLog ${APACHE_LOG_DIR}/nusantara_access.log combined
</VirtualHost>

# HTTP to HTTPS redirect
<VirtualHost *:80>
    ServerName nusantaragroup.co
    ServerAlias www.nusantaragroup.co
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>