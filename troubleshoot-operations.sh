#!/bin/bash

echo "╔═══════════════════════════════════════════════════════════════════════════╗"
echo "║           OPERATIONS DASHBOARD - TROUBLESHOOTING GUIDE                    ║"
echo "╚═══════════════════════════════════════════════════════════════════════════╝"
echo ""
echo "🔍 DIAGNOSIS MASALAH: Menu Operations redirect ke Landing Page"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ VERIFIKASI COMPLETED:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "1. ✅ Component Files Exist:"
ls -lh /root/APP-YK/frontend/src/pages/OperationalDashboard/*.jsx | awk '{print "   ", $9, "-", $5}'
echo ""

echo "2. ✅ Route Definition in App.js:"
grep -A 5 "path=\"/operations\"" /root/APP-YK/frontend/src/App.js | head -6
echo ""

echo "3. ✅ Component in Production Bundle:"
if strings /root/APP-YK/frontend-build/static/js/bundle.js | grep -q "OperationalDashboard"; then
    echo "   ✅ OperationalDashboard found in bundle.js"
else
    echo "   ❌ OperationalDashboard NOT found in bundle.js"
fi
echo ""

echo "4. ✅ Production URL Response:"
curl -sI https://nusantaragroup.co/operations | grep -E "HTTP|Location" | head -2
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "❗ MOST LIKELY PROBLEM:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "🎯 USER ROLE IS NOT 'admin'"
echo ""
echo "The /operations route requires:"
echo "   <ProtectedRoute roles={['admin']}>"
echo ""
echo "If user.role !== 'admin', ProtectedRoute redirects to:"
echo "   - /dashboard (if logged in but not admin)"
echo "   - /login (if not logged in)"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔧 SOLUTION OPTIONS:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Option 1: CHECK YOUR USER ROLE IN DATABASE"
echo "─────────────────────────────────────────────────────────────"
echo "Run this SQL query to check user roles:"
echo ""
echo "  docker exec nusantara-postgres psql -U admin -d nusantara_construction -c \\"
echo "    \"SELECT id, username, role FROM users WHERE username = 'YOUR_USERNAME';\""
echo ""
echo "Expected output:"
echo "  role | admin    ← Must be exactly 'admin' (lowercase)"
echo ""

echo "Option 2: UPDATE USER ROLE TO ADMIN"
echo "─────────────────────────────────────────────────────────────"
echo "If user role is not 'admin', update it:"
echo ""
echo "  docker exec nusantara-postgres psql -U admin -d nusantara_construction -c \\"
echo "    \"UPDATE users SET role = 'admin' WHERE username = 'YOUR_USERNAME';\""
echo ""

echo "Option 3: REMOVE ROLE RESTRICTION (NOT RECOMMENDED)"
echo "─────────────────────────────────────────────────────────────"
echo "If you want ALL logged-in users to access /operations:"
echo ""
echo "Change in /root/APP-YK/frontend/src/App.js line ~218:"
echo ""
echo "  FROM: <ProtectedRoute roles={['admin']}>"
echo "  TO:   <ProtectedRoute>"
echo ""
echo "Then rebuild:"
echo "  docker exec nusantara-frontend npm run build"
echo "  docker cp nusantara-frontend:/app/build/. /root/APP-YK/frontend-build/"
echo "  sudo systemctl restart apache2"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🧪 TESTING STEPS:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "1. Open Browser Developer Tools (F12)"
echo "2. Go to Console tab"
echo "3. Login to https://nusantaragroup.co/login"
echo "4. After login, type in console:"
echo ""
echo "   localStorage.getItem('token')"
echo ""
echo "5. Copy the token and decode at https://jwt.io"
echo "6. Check the 'role' field in the payload"
echo "7. If role !== 'admin', that's the problem!"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📝 QUICK FIX COMMAND:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "To make your current user an admin, run:"
echo ""
echo "read -p 'Enter your username: ' USERNAME && \\"
echo "docker exec nusantara-postgres psql -U admin -d nusantara_construction -c \\"
echo "  \"UPDATE users SET role = 'admin' WHERE username = '\$USERNAME'; SELECT username, role FROM users WHERE username = '\$USERNAME';\""
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "After fixing user role:"
echo "  1. Logout from application"
echo "  2. Login again (to get new token with admin role)"
echo "  3. Click Operations menu"
echo "  4. Should now show Operations Dashboard ✅"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
